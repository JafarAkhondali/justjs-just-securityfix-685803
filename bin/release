#!/bin/bash
#
# This script is intended to be run in the "postversion" npm script,
# so that it will use the last released version.
# Otherwise, you can set the new version running this script
# with the npm_package_version environment variable.
#

ROOT="${BASH_SOURCE%/*}/.." # Source: https://stackoverflow.com/a/12694189
NEW_VERSION="$npm_package_version"

cd "$ROOT"

release () {

	local version="$1"
	local commitMessage="$version"$'\n\n'

	for file in `find ./dist -maxdepth 2 -type f`; do

		commitMessage+=$'\nFile: '"$file"
		commitMessage+=$'\nIntegrity: '`./bin/generate-sri "$file"`
		commitMessage+=$'\n'

	done

	commitMessage+=$'\nChanges:\n'
	# Source: https://stackoverflow.com/a/31719777
	commitMessage+=$''`git log --oneline $(git describe --tags --abbrev=0 @^)..@`

	npm version "$version" -m "$commitMessage"

}

release "$NEW_VERSION"
