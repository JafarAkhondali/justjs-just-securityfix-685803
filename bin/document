#!/bin/bash

TAG="$1"
VERSION="${TAG/v/}"
ROOT="${BASH_SOURCE%/*}/.." # Source: https://stackoverflow.com/a/12694189
PUBLIC_DIR='docs/public'
TEMP_PUBLIC_DIR="$PUBLIC_DIR.temp"
DESTINATION_DIR="$PUBLIC_DIR/$TAG"
TEMP_DESTINATION_DIR="$TEMP_PUBLIC_DIR/$TAG"
AVAILABLE_VERSIONS=(`./bin/get-available-versions`)
runJsdoc=true

# Source: https://stackoverflow.com/a/13359121
for arg in "$@"; do

	case $arg in
		--run-jsdoc=* )

			runJsdoc="${arg#*=}"

			;;
	esac

done

cd "$ROOT"

isValidTag () {
	[[ "$1" =~ ^v[x0-9] ]]
}

copyContents () {

	local FROM=$1
	local TO=$2

	echo "[Docs] Copying the contents of $FROM to $TO"
	mkdir -p "$TO"
	cp "$FROM"/* "$TO" -R

}

copyStaticFiles () {

	copyContents docs/static/versioned "$TEMP_DESTINATION_DIR"
	copyContents docs/static/non-versioned "$TEMP_PUBLIC_DIR"
	# Exclude nunjucks files.
	rm "$TEMP_PUBLIC_DIR"/*.njk

}

document () {

	local BUILD_NAME=$1
	local DESTINATION="$TEMP_DESTINATION_DIR/$BUILD_NAME"

	echo "[Docs] Generating docs at $DESTINATION"
	npm run doc:jsdoc -- "dist/$BUILD_NAME" -d "$DESTINATION"

}

if ! isValidTag "$TAG"; then

	echo "[Docs] You should provide a release tag."
	exit 1

fi

if [ ! -d "dist" ]; then
	npm run build
fi

copyStaticFiles
nunjucks-to-html --baseDir docs/static/non-versioned --dest "$TEMP_PUBLIC_DIR"
nunjucks-to-html --baseDir docs/static/versioned --dest "$TEMP_PUBLIC_DIR/$TAG"

if [ "$runJsdoc" = true ]; then

	document browser
	document server

fi

npm run doc:minify -- --input-dir "$TEMP_PUBLIC_DIR" --output-dir "$TEMP_PUBLIC_DIR"
# Don't rename $PUBLIC_DIR. Doing so will make live-server's reloads stop working.
cp -R "$TEMP_PUBLIC_DIR"/* "$PUBLIC_DIR"
